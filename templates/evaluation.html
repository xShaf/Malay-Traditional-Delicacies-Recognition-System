{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Header -->
<div
    class="flex justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-fade-in">
    <div>
        <h1 class="text-4xl font-bold heritage-font text-gula-melaka mb-2">Model Evaluation</h1>
        <p class="text-gray-500">Comparative analysis of deep learning architectures on the Malay Traditional Delicacies
            dataset.</p>
    </div>
    <a href="/admin/dashboard"
        class="btn btn-outline gap-2 text-songket hover:bg-songket hover:text-white border-songket">
        <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
    </a>
</div>

<!-- CHARTS SECTION -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10 animate-fade-in">

    <!-- Accuracy Comparison -->
    <div class="card bg-white shadow-xl border-t-4 border-pandan">
        <div class="card-body">
            <h2 class="card-title text-pandan mb-4"><i class="fa-solid fa-chart-column"></i> Accuracy Comparison</h2>
            <div class="h-64">
                <canvas id="accuracyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Loss Comparison -->
    <div class="card bg-white shadow-xl border-t-4 border-batik-red">
        <div class="card-body">
            <h2 class="card-title text-batik-red mb-4"><i class="fa-solid fa-chart-line"></i> Validation Loss</h2>
            <div class="h-64">
                <canvas id="lossChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Global Comparison Graph -->
<div class="card bg-base-100 shadow-xl border border-base-300 mb-12">
    <div class="card-body">
        <h2 class="card-title heritage-font text-2xl text-gula-melaka mb-4">
            <i class="fa-solid fa-chart-area"></i> Overall Performance Comparison
        </h2>
        <div class="w-full flex justify-center bg-gray-50 rounded-xl p-4 border border-gray-100">
            <img src="/admin/graph/final_comparison_chart.png" alt="Final Comparison"
                class="max-w-full h-auto rounded shadow-sm hover:scale-[1.02] transition-transform duration-500">
        </div>
    </div>
</div>

<!-- DETAILED METRICS GRID -->
<h2 class="text-3xl font-bold heritage-font text-gula-melaka mb-6 pl-2 border-l-4 border-songket">Detailed Performance
    Metrics</h2>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12 animate-fade-in">
    {% for model_name, data in metrics.items() %}
    <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 border border-base-300">
        <div class="card-body p-6">
            <h3 class="card-title text-xl text-primary border-b pb-2 mb-4">{{ model_name }}</h3>

            <div class="flex flex-col gap-3">
                <!-- Accuracy -->
                <div class="flex justify-between items-center">
                    <span class="text-sm font-bold opacity-70">Accuracy</span>
                    <span
                        class="badge {{ 'badge-success text-white' if data.accuracy > 90 else ('badge-warning' if data.accuracy > 85 else 'badge-error text-white') }} font-bold">
                        {{ data.accuracy }}%
                    </span>
                </div>

                <!-- Precision -->
                <div class="flex justify-between items-center">
                    <span class="text-sm opacity-70">Precision</span>
                    <span class="font-mono text-sm">{{ data.precision }}%</span>
                </div>

                <!-- Recall -->
                <div class="flex justify-between items-center">
                    <span class="text-sm opacity-70">Recall</span>
                    <span class="font-mono text-sm">{{ data.recall }}%</span>
                </div>

                <!-- F1 Score -->
                <div class="flex justify-between items-center">
                    <span class="text-sm opacity-70">F1-Score</span>
                    <span class="font-mono text-sm">{{ data.f1_score }}%</span>
                </div>

                <!-- Loss -->
                <div class="flex justify-between items-center">
                    <span class="text-sm opacity-70">Loss</span>
                    <span class="font-mono text-sm">{{ data.loss }}</span>
                </div>
            </div>

            <div class="card-actions mt-6">
                <button
                    class="btn btn-sm btn-outline btn-block text-gula-melaka border-gula-melaka hover:bg-gula-melaka hover:text-white"
                    onclick="document.getElementById('modal_graph_{{ loop.index }}').showModal()">
                    <i class="fa-solid fa-chart-line"></i> View Graphs
                </button>
            </div>
        </div>
    </div>

    <!-- GRAPH MODAL -->
    <dialog id="modal_graph_{{ loop.index }}" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box w-11/12 max-w-5xl p-0 overflow-hidden bg-base-100">
            <div class="bg-amber-50 p-4 border-b border-amber-100 flex justify-between items-center">
                <h3 class="font-bold text-xl heritage-font text-gula-melaka">{{ model_name }} Analysis</h3>
                <form method="dialog"><button class="btn btn-sm btn-circle btn-ghost">âœ•</button></form>
            </div>

            <div class="p-6 overflow-y-auto max-h-[80vh]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Confusion Matrix -->
                    <div class="card bg-base-100 shadow border border-base-200">
                        <div class="card-body p-4">
                            <h4 class="card-title text-sm uppercase tracking-wider text-gray-500 mb-2">Confusion Matrix
                            </h4>
                            <img src="/admin/graph/cm_{{ model_name }}.png" class="w-full rounded" loading="lazy"
                                alt="Confusion Matrix">
                        </div>
                    </div>

                    <!-- Training History -->
                    <div class="card bg-base-100 shadow border border-base-200">
                        <div class="card-body p-4">
                            <h4 class="card-title text-sm uppercase tracking-wider text-gray-500 mb-2">Training History
                            </h4>
                            {% if '_FT' in model_name %}
                            <img src="/admin/graph/history_{{ model_name }}_Progress.png" class="w-full rounded"
                                loading="lazy" alt="Training History">
                            {% else %}
                            <img src="/admin/graph/history_{{ model_name }}.png" class="w-full rounded" loading="lazy"
                                alt="Training History">
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-action bg-gray-50 p-4 m-0">
                <form method="dialog"><button class="btn btn-primary btn-sm">Close</button></form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop"><button>close</button></form>
    </dialog>
    {% endfor %}
</div>

<script>
    // --- ACCURACY CHART ---
    const ctxAcc = document.getElementById('accuracyChart').getContext('2d');
    new Chart(ctxAcc, {
        type: 'bar',
        data: {
            labels: {{ chart_labels| safe }},
        datasets: [{
            label: 'Accuracy (%)',
            data: {{ chart_accuracies| safe }},
        backgroundColor: ['#134e4a', '#d97706', '#ccfbf1', '#881337'], // Theme Colors
        borderWidth: 1
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, max: 100 } },
        plugins: { legend: { display: false } }
    }
    });

    // --- LOSS CHART ---
    const ctxLoss = document.getElementById('lossChart').getContext('2d');
    new Chart(ctxLoss, {
        type: 'line',
        data: {
            labels: {{ chart_labels| safe }},
        datasets: [{
            label: 'Validation Loss',
            data: {{ chart_losses| safe }},
        borderColor: '#881337', // Batik Red
        backgroundColor: 'rgba(136, 19, 55, 0.1)',
        tension: 0.3,
        fill: true
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
    }
    });
</script>
{% endblock %}